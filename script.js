const screenshotsData = {
  basic: [
    {
      image: "src/1.jpg",
      title: "–í—ã–±–æ—Ä —É—Å–ª—É–≥–∏",
      description: "–ù–∞ —ç—Ç–æ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É –Ω–∞ —Å–∞–π—Ç–µ.",
    },
    {
      image: "src/2.jpg",
      title: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏",
      description:
        "–ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ª—É–≥–µ. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ù–∞—á–∞—Ç—å'",
    },
    {
      image: "src/3.jpg",
      title: "–£–∫–∞–∑–∞–Ω–∏–µ –ø–æ–ª–∏—Å–∞ –û–ú–°",
      description: "–ù–∞ –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø–æ–ª–∏—Å –û–ú–°",
    },
    {
      image: "src/4.jpg",
      title: "–í—ã–±–æ—Ä –≤—Ä–∞—á–∞",
      description:
        "–°–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≤—Ä–∞—á–∞ –Ω–∞ —Å–∞–π—Ç–µ",
    },
    {
      image: "src/5.jpg",
      title: "–í—ã–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞",
      description: "–°–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å –§–ò–û –≤—Ä–∞—á–∞ –Ω–∞ —Å–∞–π—Ç–µ",
    },
    {
      image: "src/6.jpg",
      title: "–í—ã–±–æ—Ä –º–µ—Å—Ç–∞ –ø–æ–ª–∏–∫–ª–∏–Ω–Ω–∏–∫–∏",
      description:
        "–í—ã–±–æ—Ä –º–µ—Å—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—Ä–∏—ë–º. –ù–∞–π–¥–∏—Ç–µ –µ–≥–æ –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ",
    },
    {
      image: "src/7.jpg",
      title: "–í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏",
      description:
        "–£–∫–∞–∂–∏—Ç–µ —É–¥–æ–±–Ω—É—é –≤–∞–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ",
    },
  ],
  advanced: [
    {
      image: "src/8.jpg",
      title: "–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–∞",
      description:
        "–ù–∞ –¥–∞–Ω–Ω–æ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ—Ç —Ä–æ–±–æ—Ç–∞ –ú–ê–ö–°, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–∞",
    },
  ],
};

let currentStep = 0;
let currentDifficulty = "basic";
let isVoiceEnabled = false;
let speech = null;
let cursorHintTimeout = null;

const screenshotImg = document.getElementById("screenshot-img");
const screenshotTitle = document.getElementById("screenshot-title");
const screenshotText = document.getElementById("screenshot-text");
const prevBtn = document.getElementById("prev-btn");
const nextBtn = document.getElementById("next-btn");
const basicBtn = document.getElementById("basic-btn");
const advancedBtn = document.getElementById("advanced-btn");
const voiceBtn = document.getElementById("voice-btn");
const voiceStatus = document.getElementById("voice-status");
const helpBtn = document.getElementById("help-btn");
const helpOverlay = document.getElementById("help-overlay");
const closeHelp = document.getElementById("close-help");
const progressFill = document.getElementById("progress-fill");
const currentStepElement = document.getElementById("current-step");
const difficultyIndicator = document.getElementById("difficulty-indicator");
const cursorHint = document.getElementById("cursor-hint");

function initializeSpeech() {
  if ("speechSynthesis" in window) {
    speech = new SpeechSynthesisUtterance();
    speech.lang = "ru-RU";
    speech.rate = 0.9;
    speech.pitch = 1;
    const voices = speechSynthesis.getVoices();
    const russianVoice = voices.find((voice) => voice.lang.startsWith("ru"));
    if (russianVoice) {
      speech.voice = russianVoice;
    }
  } else {
    voiceBtn.disabled = true;
    voiceStatus.textContent =
      "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ";
  }
}

function loadScreenshot(step) {
  const screenshots = screenshotsData[currentDifficulty];

  if (step >= 0 && step < screenshots.length) {
    const screenshot = screenshots[step];

    screenshotImg.src = screenshot.image;
    screenshotTitle.textContent = screenshot.title;
    screenshotText.textContent = screenshot.description;

    prevBtn.disabled = step === 0;
    nextBtn.disabled = step === screenshots.length - 1;

    const progress = ((step + 1) / screenshots.length) * 100;
    progressFill.style.width = `${progress}%`;

    currentStepElement.textContent = `–®–∞–≥ ${step + 1} –∏–∑ ${screenshots.length}`;
    difficultyIndicator.textContent = `–£—Ä–æ–≤–µ–Ω—å: ${currentDifficulty === "basic" ? "–ë–∞–∑–æ–≤—ã–π" : "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"}`;

    if (isVoiceEnabled) {
      speechSynthesis.cancel();
      setTimeout(() => speakCurrentDescription(), 300);
    }

    clearTimeout(cursorHintTimeout);
    cursorHintTimeout = setTimeout(showCursorHint, 1000);

    highlightActiveAreas();
  }
}

function showCursorHint() {
  const container = document.querySelector(".screenshot-container");
  const rect = container.getBoundingClientRect();

  const x = rect.left + rect.width * 0.7;
  const y = rect.top + rect.height * 0.3;

  cursorHint.style.left = `${x}px`;
  cursorHint.style.top = `${y}px`;
  cursorHint.style.opacity = "1";

  setTimeout(() => {
    const newX = rect.left + rect.width * 0.3;
    const newY = rect.top + rect.height * 0.6;

    cursorHint.style.left = `${newX}px`;
    cursorHint.style.top = `${newY}px`;
  }, 1000);

  setTimeout(() => {
    cursorHint.style.opacity = "0";
  }, 3000);
}

function highlightActiveAreas() {
  const previousHighlights = document.querySelectorAll(".highlight");
  previousHighlights.forEach((el) => el.classList.remove("highlight"));

  setTimeout(() => {
    if (currentStep < screenshotsData[currentDifficulty].length - 1) {
      nextBtn.classList.add("highlight");
    }

    if (currentStep > 0) {
      prevBtn.classList.add("highlight");
    }

    setTimeout(() => {
      nextBtn.classList.remove("highlight");
      prevBtn.classList.remove("highlight");
    }, 2000);
  }, 500);
}

function speakCurrentDescription() {
  if (!isVoiceEnabled || !speech) return;

  const screenshots = screenshotsData[currentDifficulty];
  const screenshot = screenshots[currentStep];

  speech.text = `${screenshot.title}. ${screenshot.description}`;
  speechSynthesis.speak(speech);
}

function toggleVoice() {
  isVoiceEnabled = !isVoiceEnabled;

  if (isVoiceEnabled) {
    voiceBtn.classList.add("active");
    voiceBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
    voiceStatus.textContent = "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ";
    speakCurrentDescription();
  } else {
    voiceBtn.classList.remove("active");
    voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
    voiceStatus.textContent = "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ";
    speechSynthesis.cancel();
  }
}

function changeDifficulty(difficulty) {
  currentDifficulty = difficulty;
  currentStep = 0;

  basicBtn.classList.toggle("active", difficulty === "basic");
  advancedBtn.classList.toggle("active", difficulty === "advanced");

  loadScreenshot(currentStep);
}

function init() {
  loadScreenshot(currentStep);

  initializeSpeech();

  prevBtn.addEventListener("click", () => {
    if (currentStep > 0) {
      currentStep--;
      loadScreenshot(currentStep);
    }
  });

  nextBtn.addEventListener("click", () => {
    const screenshots = screenshotsData[currentDifficulty];
    if (currentStep < screenshots.length - 1) {
      currentStep++;
      loadScreenshot(currentStep);
    }
  });

  basicBtn.addEventListener("click", () => changeDifficulty("basic"));
  advancedBtn.addEventListener("click", () => changeDifficulty("advanced"));

  voiceBtn.addEventListener("click", toggleVoice);

  helpBtn.addEventListener("click", () => {
    helpOverlay.classList.add("active");
  });

  closeHelp.addEventListener("click", () => {
    helpOverlay.classList.remove("active");
  });

  helpOverlay.addEventListener("click", (e) => {
    if (e.target === helpOverlay) {
      helpOverlay.classList.remove("active");
    }
  });

  window.speechSynthesis.onvoiceschanged = initializeSpeech;

  setTimeout(() => {
    helpBtn.classList.add("highlight");
    setTimeout(() => helpBtn.classList.remove("highlight"), 3000);
  }, 2000);
}

document.addEventListener("DOMContentLoaded", init);

let progressStore = JSON.parse(localStorage.getItem("progress")) || {};

function restoreProgress() {
  if (progressStore[currentDifficulty] !== undefined) {
    currentStep = progressStore[currentDifficulty];
    loadScreenshot(currentStep);
  }
}

function saveProgress() {
  progressStore[currentDifficulty] = currentStep;
  localStorage.setItem("progress", JSON.stringify(progressStore));
}

const oldLoadScreenshot = loadScreenshot;
loadScreenshot = function (step) {
  oldLoadScreenshot(step);
  saveProgress();

  const taskBox = document.getElementById("task-box");
  const testBox = document.getElementById("test-box");
  if (taskBox) taskBox.classList.add("hidden");
  if (testBox) testBox.classList.add("hidden");

  if (currentDifficulty === "basic" && step === 2) {
    showTask("–ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞–∂–∞—Ç—å, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É?");
  }

  if (
    step === screenshotsData[currentDifficulty].length - 1 &&
    currentDifficulty == "basic"
  ) {
    showTest();
  }
};

function showTask(text) {
  const box = document.getElementById("task-box");
  if (!box) return;
  document.getElementById("task-text").textContent = text;
  box.classList.remove("hidden");
}

function checkTask() {
  alert("–í–µ—Ä–Ω–æ!");
  document.getElementById("task-box").classList.add("hidden");
}

function showTest() {
  const box = document.getElementById("test-box");
  if (!box) return;
  box.classList.remove("hidden");
}

function finishTest() {
  alert("üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: –∫—É—Ä—Å –ø—Ä–æ–π–¥–µ–Ω!");
  document.getElementById("test-box").classList.add("hidden");
}

const oldInit = init;
init = function () {
  oldInit();
  restoreProgress();
};
